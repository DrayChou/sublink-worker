# D1 订阅缓存功能实现记录

> 文档生成时间: 2026-01-15
> 目的: 解决时效性订阅链接（token 10分钟/1次可用）的问题

---

## 1. 背景与问题

### 1.1 问题描述

很多订阅站生成的链接有时效性限制：
- Token 只有一次请求可用
- Token 10分钟后过期
- 源站服务器可能挂掉

用户需要：首次成功请求后缓存内容，后续直接使用缓存，即使源站不可用。

### 1.2 解决方案

使用 Cloudflare **D1 数据库** 永久存储订阅内容：
- 首次请求成功 → 存入 D1
- 后续请求 → 优先用缓存，失败时降级到缓存

---

## 2. 实现的功能

### 2.1 核心逻辑

```javascript
// fetchWithCache 核心流程
async function fetchWithCache(url) {
    const cacheKey = generateCacheKey(url);

    // 1. 尝试远程获取
    try {
        const content = await fetchWithRetry(url); // 3次重试
        await saveToCache(cacheKey, url, content); // 成功则更新缓存
        return { content, fromCache: false, success: true };
    } catch (error) {
        // 2. 失败时使用缓存
        const cached = await getCachedContent(cacheKey);
        if (cached) {
            return { content: cached.content, fromCache: true, success: true, warning: 'using cached content' };
        }
        // 3. 无缓存，返回错误
        return { success: false, error: error.message };
    }
}
```

### 2.2 User-Agent 轮换

支持多种代理工具的 User-Agent，提高请求成功率：
```javascript
const USER_AGENTS = [
    'FlClash/v0.8.74 clash-verge Platform/windows',
    'curl/7.88.1',
    'ClashforWindows/0.20.31',
    'clash-verge/v1.7.4',
    'Surge/5.2.0',
    'Quantumult%20X/1.2.3',
    'ShadowsocksX-NG/1.8.2',
    // ... 浏览器 UA
];
```

### 2.3 缓存启用参数

```bash
# 启用缓存（默认）
/singbox?config=xxx

# 禁用缓存
/singbox?config=xxx&cache=false
```

### 2.4 管理端点

| 端点 | 功能 |
|------|------|
| `GET /cache-stats` | 查看缓存统计 |
| `GET /cache-clear` | 清空所有缓存 |

---

## 3. 文件变更

### 3.1 新增文件

| 文件 | 说明 |
|------|------|
| `migrations/0001_create_subscription_cache.sql` | D1 数据库 schema |
| `docs/开发记录/D1缓存功能实现记录.md` | 本开发记录 |

### 3.2 修改文件

| 文件 | 修改内容 |
|------|---------|
| `src/cacheManager.js` | 重写为 D1 适配，支持自动初始化 |
| `src/ProxyParsers.js` | 添加 `cacheEnabled` 参数 |
| `src/BaseConfigBuilder.js` | 添加 `cacheEnabled` 参数 |
| `src/SingboxConfigBuilder.js` | 接受 `cacheEnabled` 参数 |
| `src/ClashConfigBuilder.js` | 接受 `cacheEnabled` 参数 |
| `src/SurgeConfigBuilder.js` | 接受 `cacheEnabled` 参数 |
| `src/index.js` | 缓存全局参数 + 新增管理端点 |
| `wrangler.toml` | 添加 D1 绑定配置 |
| `.github/workflows/deploy.yml` | 添加 D1 创建和迁移步骤 |

---

## 4. D1 Schema

```sql
CREATE TABLE subscription_cache (
    cache_key TEXT PRIMARY KEY,      -- URL 的 hash
    url TEXT NOT NULL,               -- 原始 URL（用于参考）
    content TEXT NOT NULL,           -- 缓存的订阅内容
    created_at INTEGER NOT NULL,     -- 首次缓存时间
    updated_at INTEGER NOT NULL,     -- 最后更新时间
    success_count INTEGER DEFAULT 1, -- 成功请求次数
    fail_count INTEGER DEFAULT 0     -- 失败请求次数
);
```

---

## 5. 部署步骤

### 5.1 首次部署（GitHub Actions 自动）

1. 推送代码到 main 分支
2. GitHub Actions 会自动：
   - 检查/创建 KV 命名空间
   - 检查/创建 D1 数据库
   - 执行 D1 迁移
   - 部署 Worker

### 5.2 手动创建 D1（如果自动失败）

```bash
# 登录 Cloudflare
npx wrangler login

# 创建 D1 数据库
npx wrangler d1 create subscription-db

# 记录返回的 database_id

# 执行迁移
npx wrangler d1 execute subscription-db --remote --file=migrations/0001_create_subscription_cache.sql

# 查看 D1 数据库列表
npx wrangler d1 list
```

### 5.3 手动更新 wrangler.toml

如果 D1 自动创建失败，手动更新 `wrangler.toml`：

```toml
[[d1_databases]]
binding = "SUBSCRIPTION_DB"
database_name = "subscription-db"
database_id = "你的database_id"  # 替换为实际的 ID
```

---

## 6. 成本对比

| 服务 | 价格 | 适合场景 |
|------|------|---------|
| Workers KV 读取 | $0.5/百万 | ❌ 贵 |
| Workers KV 写入 | $1.0/百万 | ❌ 贵 |
| D1 查询 | $0.005/百万 | ✅ 便宜 100 倍 |

对于订阅缓存场景，D1 是更好的选择。

---

## 7. API 参考

### 7.1 cacheManager.js 导出

```javascript
// 核心函数
export async function fetchWithCache(url, options) {
    // options: { headers, maxRetries }
    // 返回: { content, fromCache, success, warning?, error? }
}

export async function saveToCache(cacheKey, url, content) {
    // 保存到 D1
}

export async function getCachedContent(cacheKey) {
    // 从 D1 获取
    // 返回: { content, successCount, failCount, createdAt }
}

export async function clearCache(cacheKey) {
    // 清除单个缓存
}

export async function clearAllCache() {
    // 清除所有缓存
}

export async function getCacheStats() {
    // 返回: { totalCached, withSuccess }
}

export async function initDatabase() {
    // 初始化 D1 表结构（自动调用）
}
```

### 7.2 URL 参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `cache` | 是否启用缓存 | `true` |
| `ua` | User-Agent | `curl/7.74.0` |

---

## 8. 故障排查

### 8.1 D1 未初始化

错误: `D1 database not initialized`

解决: 检查 `wrangler.toml` 中的 D1 绑定是否正确配置。

### 8.2 缓存未命中

检查 `/cache-stats` 端点的输出，确认：
- D1 已初始化
- 有缓存记录

### 8.3 部署失败

1. 检查 Cloudflare API Token 权限
2. 确认 D1 数据库已创建
3. 检查 `wrangler.toml` 格式是否正确

---

## 9. 后续优化方向

1. **缓存预热**: 定时刷新热门订阅
2. **智能淘汰**: 基于使用频率淘汰旧缓存
3. **监控告警**: 缓存命中率监控
4. **分库策略**: 按来源分库管理

---

## 10. 相关链接

- Cloudflare D1 文档: https://developers.cloudflare.com/d1/
- Cloudflare Workers: https://workers.cloudflare.com/
- 项目仓库: https://github.com/DrayChou/sublink-worker
